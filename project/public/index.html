<html>
    <body>
        <header>
            <title>Carte des caméras</title>
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""/>
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
            <style>
                #map {
                    height: 700px;
                }
            </style>
        </header>
        <main>
            <h1>Carte de caméras :</h1>
            <div id="map"></div>
        </main>
    </body>
    <script>
        const {offsetWidth: mapWidth, offsetHeight: mapHeight} = document.getElementById("map")

        const map = L.map('map').setView([47.272899, 2.446147], 6);
        let markers = [];
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        function fetchCameras(){
            const {lat: lat2, lng: lng1} = map.containerPointToLatLng(L.point(0, 0))

            const {lat: lat1, lng: lng2} = map.containerPointToLatLng(L.point(mapWidth, mapHeight))

            fetch(`/api/cameras?bbox=${[lng1,lat1,lng2,lat2].join(",")}&width=${mapWidth}&height=${mapHeight}`)
                .then(res => res.json())
                .then(datas => {
                    cleanMarkers()

                    for (const data of datas) {
                        const marker = new L.Marker({lat: data.lat, lng: data.lon}, data.type === "zone" ?{
                            icon: new L.DivIcon({
                                html: data.count.toString()
                            })
                        } : undefined);
                        map.addLayer(marker);

                        markers.push(marker);
                    }
                })
        }
        function cleanMarkers() {
            for (const marker of markers) {
                map.removeLayer(marker)
            }
            markers = [];
        }

        fetchCameras();
        map.on("moveend", fetchCameras)
    </script>
</html>